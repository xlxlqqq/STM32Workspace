#include "ad7606.h"

/* ∏¥Œª±‰¡ø∫Í∂®“Â */
#define AD_RST PBout(8)

/* π˝≤…—˘¬ øÿ÷∆“˝Ω≈OS0∫Í∂®“Â */
#define AD_OS0 PCout(0)

/* π˝≤…—˘¬ øÿ÷∆“˝Ω≈OS0£¨OS1£¨OS2∫Í∂®“Â*/
#define AD_OS1 PCout(1)
#define AD_OS2 PCout(2) 

/* …Ë÷√AD≤…—˘∑∂Œß°£0Œ™-5V~5V°£1Œ™-10V~10V°£*/
#define AD_RANGE PCout(3)
/* SPIÕ®–≈ ∆¨—°–≈∫≈*/
#define AD_CS PBout(9)
//#define AD_IRQ_FLAG PCout(6)
/*
 *ºÚΩÈ£∫≥ı ºªØADƒ£øÈ∏˜øÿ÷∆“˝Ω≈
 *≤Œ ˝£∫Œﬁ
*/
void ad7606_gpio_init()
{
	GPIO_InitTypeDef  GPIO_InitStructure;

  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOC | RCC_AHB1Periph_GPIOB, ENABLE);// πƒ‹GPIOC ±÷”

  //PC0,PC1,PC2“˝Ω≈≥ı ºªØ£¨”√”⁄øÿ÷∆π˝≤…—˘±∂ ˝°£OS0£¨OS1£¨OS2
	//≥ı ºªØ…Ë÷√Œ™œ¬¿≠£¨ƒ¨»œ≤…—˘±∂ ˝Œ™0.
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2|GPIO_Pin_6;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;//∆’Õ® ‰≥ˆƒ£ Ω
  GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//Õ∆ÕÏ ‰≥ˆ
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;//100MHz
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_DOWN;//œ¬¿≠
  GPIO_Init(GPIOC, &GPIO_InitStructure);//≥ı ºªØGPIO
	
	GPIO_ResetBits(GPIOC,GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2|GPIO_Pin_6);//»˝∏ˆ“˝Ω≈‘Ÿ¥Œ…Ë÷√µÕŒª ‰≥ˆ
	
	//PC3“˝Ω≈≥ı ºªØ…Ë÷√£¨”√”⁄øÿ÷∆≤…—˘∑∂Œß£¨ƒ¨»œŒ™…œ¿≠£¨10V°£
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_3;//∂‘”¶RANGE“˝Ω≈
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;//∆’Õ® ‰≥ˆƒ£ Ω
  GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//Õ∆ÕÏ ‰≥ˆ
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;//100MHz
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;//…œ¿≠
  GPIO_Init(GPIOC, &GPIO_InitStructure);//≥ı ºªØGPIO
	
	GPIO_SetBits(GPIOC,GPIO_Pin_3);
	
	//PB8“˝Ω≈≥ı ºªØ°£øÿ÷∆ADƒ£øÈ∏¥Œª÷ÿ∆Ù°£ƒ¨»œ¿≠µÕ°£PB9Œ™SPI1∆¨—°–≈∫≈
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8 | GPIO_Pin_9;//∂‘”¶RST“˝Ω≈
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;//∆’Õ® ‰≥ˆƒ£ Ω
  GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//Õ∆ÕÏ ‰≥ˆ
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;//100MHz
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;//œ¬¿≠
  GPIO_Init(GPIOB, &GPIO_InitStructure);//≥ı ºªØGPIO
	
	GPIO_ResetBits(GPIOB,GPIO_Pin_8);
}

/*
 *ºÚΩÈ£∫≥ı ºªØPWM≤® ‰≥ˆ“˝Ω≈£¨øÿ÷∆A/D–æ∆¨≤…—˘    ‰≥ˆ“˝Ω≈Œ™TIM4µƒCH1∫ÕCH2£¨∂‘”¶PB6∫ÕPB7“˝Ω≈
 * ‰»Î≤Œ ˝:arr◊‘∂Ø÷ÿ◊∞÷µ
 * ‰»Î≤Œ ˝:psc°£∂® ±∆˜ ±÷”Œ™84MHz£¨∑÷∆µœµ ˝“ª∞„…Ë∂®Œ™84£¨º∆ ˝∆µ¬ Œ™1MHz,…Ë∂®÷ÿ◊∞‘⁄÷µŒ™arr,‘ÚPWMµƒ∆µ¬ Œ™1MHz/arr.arr=50µƒ ±∫ÚŒ™20KHz°£
*/
void ad7606_pwm_init(u32 arr,u32 psc)
{		 					 
	//¥À≤ø∑÷–Ë ÷∂Ø–ﬁ∏ƒIOø⁄…Ë÷√
	
	GPIO_InitTypeDef GPIO_InitStructure;
	TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
	TIM_OCInitTypeDef  TIM_OCInitStructure;
	
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM4,ENABLE);  	//TIM14 ±÷” πƒ‹    
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOB, ENABLE); 	// πƒ‹PORTF ±÷”	
	
	GPIO_PinAFConfig(GPIOB,GPIO_PinSource6,GPIO_AF_TIM4); //GPIOB6∏¥”√Œ™∂® ±∆˜14
	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6;           //GPIOB6
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;        //∏¥”√π¶ƒ‹
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;	//ÀŸ∂»100MHz
	GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;      //Õ∆ÕÏ∏¥”√ ‰≥ˆ
	GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;        //…œ¿≠
	GPIO_Init(GPIOB,&GPIO_InitStructure);              //≥ı ºªØPB6
	  
	TIM_TimeBaseStructure.TIM_Prescaler=psc;  //∂® ±∆˜∑÷∆µ
	TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Up; //œÚ…œº∆ ˝ƒ£ Ω
	TIM_TimeBaseStructure.TIM_Period=arr;   //◊‘∂Ø÷ÿ◊∞‘ÿ÷µ
	TIM_TimeBaseStructure.TIM_ClockDivision=TIM_CKD_DIV1; 
	
	TIM_TimeBaseInit(TIM4,&TIM_TimeBaseStructure);//≥ı ºªØ∂® ±∆˜14
	
	//≥ı ºªØTIM14 Channel1 PWMƒ£ Ω	 
	TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1; //—°‘Ò∂® ±∆˜ƒ£ Ω:TIM¬ˆ≥ÂøÌ∂»µ˜÷∆ƒ£ Ω2
 	TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable; //±»Ωœ ‰≥ˆ πƒ‹
	TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_Low; // ‰≥ˆº´–‘:TIM ‰≥ˆ±»Ωœº´–‘µÕ
	
	TIM_OC1Init(TIM4, &TIM_OCInitStructure);  //∏˘æ›T÷∏∂®µƒ≤Œ ˝≥ı ºªØÕ‚…ËTIM1 4OC1
	
	TIM_OC1PreloadConfig(TIM4, TIM_OCPreload_Enable);  // πƒ‹TIM14‘⁄CCR1…œµƒ‘§◊∞‘ÿºƒ¥Ê∆˜
 

	GPIO_PinAFConfig(GPIOB,GPIO_PinSource7,GPIO_AF_TIM4); //GPIOF9∏¥”√Œ™∂® ±∆˜14
	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_7;           //GPIOB7
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;        //∏¥”√π¶ƒ‹
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;	//ÀŸ∂»100MHz
	GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;      //Õ∆ÕÏ∏¥”√ ‰≥ˆ
	GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;        //…œ¿≠
	GPIO_Init(GPIOB,&GPIO_InitStructure);              //≥ı ºªØPF9
	
	//≥ı ºªØTIM14 Channel1 PWMƒ£ Ω	 
	TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1; //—°‘Ò∂® ±∆˜ƒ£ Ω:TIM¬ˆ≥ÂøÌ∂»µ˜÷∆ƒ£ Ω2
 	TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable; //±»Ωœ ‰≥ˆ πƒ‹
	TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_Low; // ‰≥ˆº´–‘:TIM ‰≥ˆ±»Ωœº´–‘µÕ
	
	TIM_OC2Init(TIM4, &TIM_OCInitStructure);  //∏˘æ›T÷∏∂®µƒ≤Œ ˝≥ı ºªØÕ‚…ËTIM1 4OC1
	
	TIM_OC2PreloadConfig(TIM4, TIM_OCPreload_Enable);  // πƒ‹TIM14‘⁄CCR1…œµƒ‘§◊∞‘ÿºƒ¥Ê∆˜
  
	TIM_ARRPreloadConfig(TIM4,ENABLE);//ARPE πƒ‹ 
	
	TIM_Cmd(TIM4, ENABLE);  // πƒ‹TIM14		
}  

/*
 *ºÚΩÈ£∫–æ∆¨÷ÿ∆Ù“˝Ω≈RST…Ë÷√°£RST¿≠∏ﬂ÷¡…Ÿ50ns£¨»ª∫Û¿≠µÕ
 *≤Œ ˝£∫Œﬁ
*/
void ad7606_rst(void)
{
	AD_RST=1;
	delay_us(1);
	AD_RST=0;
}

/*
 *ºÚΩÈ£∫ADƒ£øÈ≤…—˘¬ …Ë÷√
 *≤Œ ˝:mul_os.ƒ„œÎ“™…Ë÷√µƒπ˝≤…—˘±∂ ˝£¨0.2,4,8,16,32,64°£»Áπ˚ ‰»Îµƒ≤ª «’‚–© ˝÷–µƒ£¨æÕƒ¨»œŒ™0°£
*/
void ad7606_os_set(u8 mul_os)
{
		u16 num_os=0;
		switch(mul_os)
		{
			case 0:	num_os = 0x000;
							break;
			case 2:	num_os = 0x001;
							break;
			case 4:	num_os = 0x010;
							break;
			case 8:	num_os = 0x011;
							break;
			case 16:num_os = 0x100;
							break;
			case 32:num_os = 0x101;
							break;
			case 64:num_os = 0x110;
							break;
			default:num_os = 0x000;
							break;
		}
		AD_OS0 = num_os&0x001;
		AD_OS1 = (num_os>>4)&0x001;
		AD_OS2 = (num_os>>8)&0x001;	
}

/*
 *ºÚΩÈ£∫…Ë÷√ADƒ£øÈµƒ≤…—˘∑∂Œß.
 *≤Œ ˝£∫num_range,∑∂Œß…Ë∂®÷µ°£5£¨…Ë÷√≤Œ ˝∑∂ŒßŒ™-5V~5V.10,≤Œ ˝∑∂ŒßŒ™-10V~10V°£ƒ¨»œŒ™10°£
*/
void ad7606_range_set(u8 num_range)
{
	if (num_range == 5){
		AD_RANGE = 0;
	} else AD_RANGE = 1;
}
/*
 *ºÚΩÈ£∫ø™∑¢∞ÂSPI1≥ı ºªØ£¨”√”⁄∫ÕADƒ£øÈÕ®–≈°£SPI…Ë÷√£¨CPHA=0£¨‘⁄SCKµ⁄“ª∏ˆÃı±ﬂ—ÿ≤…—˘ ˝æ›°£CPOL=1£¨ø’œ–◊¥Ã¨£¨∏ﬂµ„∆Ω°£
 *≤Œ ˝£∫Œﬁ
*/
void spi1_init(void)
{	 
  GPIO_InitTypeDef  GPIO_InitStructure;
  SPI_InitTypeDef  SPI_InitStructure;
	
  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOC, ENABLE);// πƒ‹GPIOB ±÷”
  RCC_APB1PeriphClockCmd(RCC_APB1Periph_SPI3, ENABLE);// πƒ‹SPI1 ±÷”
 
  //GPIOFB3,4,5≥ı ºªØ…Ë÷√
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10|GPIO_Pin_11|GPIO_Pin_12;//PB3~5∏¥”√π¶ƒ‹ ‰≥ˆ	
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;//∏¥”√π¶ƒ‹
  GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//Õ∆ÕÏ ‰≥ˆ
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;//100MHz
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;//…œ¿≠
  GPIO_Init(GPIOC, &GPIO_InitStructure);//≥ı ºªØ
	
	GPIO_PinAFConfig(GPIOC,GPIO_PinSource10,GPIO_AF_SPI3); //PB3∏¥”√Œ™ SPI1
	GPIO_PinAFConfig(GPIOC,GPIO_PinSource11,GPIO_AF_SPI3); //PB4∏¥”√Œ™ SPI1
	GPIO_PinAFConfig(GPIOC,GPIO_PinSource12,GPIO_AF_SPI3); //PB5∏¥”√Œ™ SPI1
 
	//’‚¿Ô÷ª’Î∂‘SPIø⁄≥ı ºªØ
	RCC_APB1PeriphResetCmd(RCC_APB1Periph_SPI3,ENABLE);//∏¥ŒªSPI1
	RCC_APB1PeriphResetCmd(RCC_APB1Periph_SPI3,DISABLE);//Õ£÷π∏¥ŒªSPI1

	SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;  //…Ë÷√SPIµ•œÚªÚ’ﬂÀ´œÚµƒ ˝æ›ƒ£ Ω:SPI…Ë÷√Œ™À´œﬂÀ´œÚ»´À´π§
	SPI_InitStructure.SPI_Mode = SPI_Mode_Master;		//…Ë÷√SPIπ§◊˜ƒ£ Ω:…Ë÷√Œ™÷˜SPI
	SPI_InitStructure.SPI_DataSize = SPI_DataSize_16b;		//…Ë÷√SPIµƒ ˝æ›¥Û–°:SPI∑¢ÀÕΩ” ’8Œª÷°Ω·ππ
	SPI_InitStructure.SPI_CPOL = SPI_CPOL_High;		//¥Æ––Õ¨≤Ω ±÷”µƒø’œ–◊¥Ã¨Œ™∏ﬂµÁ∆Ω
	SPI_InitStructure.SPI_CPHA = SPI_CPHA_2Edge;	//¥Æ––Õ¨≤Ω ±÷”µƒµ⁄∂˛∏ˆÃ¯±‰—ÿ£®…œ…˝ªÚœ¬Ωµ£© ˝æ›±ª≤…—˘
	SPI_InitStructure.SPI_NSS = SPI_NSS_Soft;		//NSS–≈∫≈”…”≤º˛£®NSSπ‹Ω≈£©ªπ «»Ìº˛£® π”√SSIŒª£©π‹¿Ì:ƒ⁄≤øNSS–≈∫≈”–SSIŒªøÿ÷∆
	SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_8;		//∂®“Â≤®Ãÿ¬ ‘§∑÷∆µµƒ÷µ:≤®Ãÿ¬ ‘§∑÷∆µ÷µŒ™256
	SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;	//÷∏∂® ˝æ›¥´ ‰¥”MSBŒªªπ «LSBŒªø™ º: ˝æ›¥´ ‰¥”MSBŒªø™ º
	SPI_InitStructure.SPI_CRCPolynomial = 7;	//CRC÷µº∆À„µƒ∂‡œÓ Ω
	SPI_Init(SPI3, &SPI_InitStructure);  //∏˘æ›SPI_InitStruct÷–÷∏∂®µƒ≤Œ ˝≥ı ºªØÕ‚…ËSPIxºƒ¥Ê∆˜
 
  SPI_Cmd(SPI3,DISABLE);
	SPI_Cmd(SPI3, ENABLE); // πƒ‹SPIÕ‚…Ë
} 

/*
 *SPI1ÀŸ∂»…Ë÷√∫Ø ˝
 *SPIÀŸ∂»=fAPB2/∑÷∆µœµ ˝
 *@ref SPI_BaudRate_Prescaler:SPI_BaudRatePrescaler_2~SPI_BaudRatePrescaler_256  
 *fAPB2 ±÷”“ª∞„Œ™84Mhz£
*/
void SPI1_SetSpeed(u8 SPI_BaudRatePrescaler)
{
  assert_param(IS_SPI_BAUDRATE_PRESCALER(SPI_BaudRatePrescaler));//≈–∂œ”––ß–‘
	SPI1->CR1&=0XFFC7;//Œª3-5«Â¡„£¨”√¿¥…Ë÷√≤®Ãÿ¬ 
	SPI1->CR1|=SPI_BaudRatePrescaler;	//…Ë÷√SPI1ÀŸ∂» 
	SPI_Cmd(SPI1,ENABLE); // πƒ‹SPI1
} 

/*
 *ºÚΩÈ£∫∂® ±∆˜5Õ®µ¿1 ‰»Î≤∂ªÒ≈‰÷√
 * ‰»Î≤Œ ˝arr£∫◊‘∂Ø÷ÿ◊∞÷µ(TIM2,TIM5 «32Œªµƒ!!)
 * ‰»Î≤Œ ˝psc£∫ ±÷”‘§∑÷∆µ 
*/
void ad7606_busy_cap(u32 arr,u16 psc)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
	NVIC_InitTypeDef NVIC_InitStructure;
	TIM_ICInitTypeDef  TIM5_ICInitStructure;
	
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM5,ENABLE);  	//TIM5 ±÷” πƒ‹    
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA, ENABLE); 	// πƒ‹PORTA ±÷”	
	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0; //GPIOA0
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;//∏¥”√π¶ƒ‹
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;	//ÀŸ∂»100MHz
	GPIO_InitStructure.GPIO_OType = GPIO_OType_PP; //Õ∆ÕÏ∏¥”√ ‰≥ˆ
	GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_DOWN; //œ¬¿≠
	GPIO_Init(GPIOA,&GPIO_InitStructure); //≥ı ºªØPA0

	GPIO_PinAFConfig(GPIOA,GPIO_PinSource0,GPIO_AF_TIM5); //PA0∏¥”√Œª∂® ±∆˜5
  
	  
	TIM_TimeBaseStructure.TIM_Prescaler=psc;  //∂® ±∆˜∑÷∆µ
	TIM_TimeBaseStructure.TIM_CounterMode=TIM_CounterMode_Up; //œÚ…œº∆ ˝ƒ£ Ω
	TIM_TimeBaseStructure.TIM_Period=arr;   //◊‘∂Ø÷ÿ◊∞‘ÿ÷µ
	TIM_TimeBaseStructure.TIM_ClockDivision=TIM_CKD_DIV1; 
	
	TIM_TimeBaseInit(TIM5,&TIM_TimeBaseStructure);
	

	//≥ı ºªØTIM5 ‰»Î≤∂ªÒ≤Œ ˝
	TIM5_ICInitStructure.TIM_Channel = TIM_Channel_1; //CC1S=01 	—°‘Ò ‰»Î∂À IC1”≥…‰µΩTI1…œ
  TIM5_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Falling;	//…œ…˝—ÿ≤∂ªÒ
  TIM5_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI; //”≥…‰µΩTI1…œ
  TIM5_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM5_ICInitStructure.TIM_ICFilter = 0x00;//IC1F=0000 ≈‰÷√ ‰»Î¬À≤®∆˜ ≤ª¬À≤®
  TIM_ICInit(TIM5, &TIM5_ICInitStructure);
	
	TIM_ITConfig(TIM5,TIM_IT_Update|TIM_IT_CC1,ENABLE);//‘ –Ì∏¸–¬÷–∂œ ,‘ –ÌCC1IE≤∂ªÒ÷–∂œ	
	
  TIM_Cmd(TIM5,ENABLE ); 	// πƒ‹∂® ±∆˜5

  NVIC_InitStructure.NVIC_IRQChannel = TIM5_IRQn;
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=2;//«¿’º”≈œ»º∂2
	NVIC_InitStructure.NVIC_IRQChannelSubPriority =2;		//◊””≈œ»º∂2
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;			//IRQÕ®µ¿ πƒ‹
	NVIC_Init(&NVIC_InitStructure);	//∏˘æ›÷∏∂®µƒ≤Œ ˝≥ı ºªØVICºƒ¥Ê∆˜°¢
	
	
}
/*
*SPI1 ∂¡–¥“ª∏ˆ◊÷Ω⁄
*TxData:“™–¥»Îµƒ◊÷Ω⁄
*∑µªÿ÷µ:∂¡»°µΩµƒ◊÷ ˝
*/
u16 SPI3_Read2Byte(void)
{		 			 
	u8 retry=0;
	SPI_Cmd(SPI3, ENABLE); // πƒ‹SPIÕ‚…Ë
	AD_CS=0;
	SPI_I2S_SendData(SPI3,0x0000);
	while(SPI_I2S_GetFlagStatus(SPI3,SPI_I2S_FLAG_RXNE) == RESET)
	{
		retry++;
		if(retry>200) return 0x1010;
	}
	AD_CS=1;
	SPI_Cmd(SPI3, DISABLE); // πƒ‹SPIÕ‚…Ë
 	return SPI_I2S_ReceiveData(SPI3);	    
}
//∂® ±∆˜5÷–∂œ∑˛ŒÒ≥Ã–Ú	 
void TIM5_IRQHandler(void)
{ 		    
	u8 i;
	u16 data[8];
	if(TIM_GetITStatus(TIM5, TIM_IT_CC1) != RESET)//≤∂ªÒ1∑¢…˙≤∂ªÒ ¬º˛
	{
		//AD_IRQ_FLAG=1;
		for(i = 0;i<8;i++)
		{
			data[i]=SPI3_Read2Byte();
		}
		for(i=0;i<8;i++){
		printf("%x¥ŒµƒAD÷µŒ™:%x\r\n",i,data[i]);
		delay_us(1);
			}				
	}
	TIM_ClearITPendingBit(TIM5, TIM_IT_CC1|TIM_IT_Update); //«Â≥˝÷–∂œ±Í÷æŒª
	//AD_IRQ_FLAG=0;
}
